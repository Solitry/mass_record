<body>
    <p>
        目标等级: <input type="int" id="target_level" value="150"/>
    </p>
    <p>
        当前等级: <input type="int" id="current_level" value="145"/>
    </p>
    <p>
        当前经验:  <input type="int" id="current_exp" value="1234567"/>
    </p>
    <p>
        加速次数:  <input type="int" id="speed_up_num" value="10"/>
    </p>
    <p>
        家园经验（每天）:  <input type="float" id="family_exp_pre_day" value="3500000"/>
    </p>
    <p>
        推图经验（每小时）:  <input type="float" id="main_exp_pre_hour" value="621500"/>
    </p>
    <p>
        副本经验（每次）:  <input type="float" id="zone_exp_pre_time" value="3520000"/>
    </p>
    <p>
        每天在线时间（小时）:  <input type="float" id="online_hours_every_day" value="1"/>
    </p>

    <p>
        <button id="btn">compute</button>
    </p>

    <script>
        
        function get_rest_exp(current_level, target_level, current_exp) {
            var target_exp = 0;
            for (var lv = current_level; lv < target_level; ++lv) {
                if (lv <= 100) {
                    target_exp += 1500 * lv * lv;
                } else {
                    target_exp += 2999 * lv * lv + lv * lv * lv;
                }
            }
            return target_exp - current_exp;
        }

        function get_today_rest_min(current_date) {
            var h = current_date.getHours();
            var m = current_date.getMinutes();
            return 60 * (24 - h) + (60 - m);
        }

        function get_today_zero_date(current_date) {
            return new Date(current_date.toLocaleDateString());
        }

        function has_zone_exp(target_date) {
            var w = target_date.getDay();
            return (w == 2 || w == 0);
        }

        function shift_n_days(start_date, n_days) {
            return new Date(start_date.getTime() + (n_days * (24 * 60 * 60) + 600) * 1000);
        }

        String.prototype.format = function(args) {
            var result = this;
            if (arguments.length > 0) {    
                if (arguments.length == 1 && typeof (args) == "object") {
                    for (var key in args) {
                        if (args[key]!=undefined){
                            var reg = new RegExp("({" + key + "})", "g");
                            result = result.replace(reg, args[key]);
                        }
                    }
                }
                else {
                    for (var i = 0; i < arguments.length; i++) {
                        if (arguments[i] != undefined) {
                            //var reg = new RegExp("({[" + i + "]})", "g");//这个在索引大于9时会有问题
                            var reg = new RegExp("({)" + i + "(})", "g");
                            result = result.replace(reg, arguments[i]);
                        }
                    }
                }
            }
            return result;
        }

        String.prototype.hashCode = function(){
            if (Array.prototype.reduce){
                return this.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);              
            } 
            var hash = 0;
            if (this.length === 0) return hash;
            for (var i = 0; i < this.length; i++) {
                var character  = this.charCodeAt(i);
                hash  = ((hash<<5)-hash)+character;
                hash = hash & hash; // Convert to 32bit integer
            }
            return hash;
        }

        document.getElementById("btn").onclick = function() {
            target_level = parseInt(document.getElementById("target_level").value);
            current_level = parseInt(document.getElementById("current_level").value);
            current_exp = parseInt(document.getElementById("current_exp").value);
            speed_up_num = parseInt(document.getElementById("speed_up_num").value);
            family_exp_pre_day = parseFloat(document.getElementById("family_exp_pre_day").value);
            main_exp_pre_hour = parseFloat(document.getElementById("main_exp_pre_hour").value);
            zone_exp_pre_time = parseFloat(document.getElementById("zone_exp_pre_time").value);
            online_hours_every_day = parseFloat(document.getElementById("online_hours_every_day").value);
            
            if (isNaN(target_level)) { alert("目标等级 填写有误！"); return; }
            if (isNaN(current_level)) { alert("当前等级 填写有误！"); return; }
            if (isNaN(current_exp)) { alert("当前经验 填写有误！"); return; }
            if (isNaN(speed_up_num)) { alert("加速次数 填写有误！"); return; }
            if (isNaN(family_exp_pre_day)) { alert("家园经验 填写有误！"); return; }
            if (isNaN(main_exp_pre_hour)) { alert("推图经验 填写有误！"); return; }
            if (isNaN(zone_exp_pre_time)) { alert("副本经验 填写有误！"); return; }
            if (isNaN(online_hours_every_day)) { alert("每天在线时间 填写有误！"); return; }

            console.log(target_level);
            // console.log(current_level);
            // console.log(current_exp);
            // console.log(speed_up_num);
            // console.log(family_exp_pre_day);
            // console.log(main_exp_pre_hour);
            // console.log(zone_exp_pre_time);
            // console.log(online_hours_every_day);

            // alert("click" + document.getElementById("level").value);

            var rest_exp = get_rest_exp(current_level, target_level, current_exp);

            var current_date = new Date();
            // console.log(current_date);
            // console.log(current_date.getHours());
            // console.log(current_date.getMinutes());
            // console.log(current_date.getDay());
            // console.log(current_date.getFullYear());
            // console.log(current_date.getMonth());
            // console.log(current_date.getDate());
            
            var today_rest_min = get_today_rest_min(current_date);
            var today_rest_exp = today_rest_min / 60 * main_exp_pre_hour;

            // console.log("aaa", rest_exp, today_rest_exp);

            if (today_rest_exp > rest_exp) {
                alert("今天就可以转生啦！");
                return;
            }

            var rest_exp_after_today = rest_exp - today_rest_exp;

            var today_zero_date = get_today_zero_date(current_date);
            var rest_exp_last_day = rest_exp_after_today;
            var last_day_index = -1;

            for (var i = 1; i < 366; ++i) {
                var target_day_date = shift_n_days(today_zero_date, i);

                var target_day_main_exp = (24 + speed_up_num * 2 + online_hours_every_day * 0.1) * main_exp_pre_hour;
                var target_day_family_exp = family_exp_pre_day;
                var target_day_zone_exp = has_zone_exp(target_day_date) ? zone_exp_pre_time * 6 : 0;

                var target_day_sum_exp = target_day_main_exp + target_day_family_exp + target_day_zone_exp;
                // console.log("here", target_day_main_exp, target_day_family_exp, target_day_zone_exp);

                if (rest_exp_last_day < target_day_sum_exp) {
                    last_day_index = i;
                    break;
                } else {
                    rest_exp_last_day -= target_day_sum_exp;
                }
            }

            if (last_day_index == -1) {
                alert("还有一年以上！");
                return;
            }

            // console.log(rest_exp_last_day);

            var show_text = "";

            show_text += "剩余{0}天\n".format(last_day_index);

            var last_day_date = shift_n_days(today_zero_date, last_day_index);

            var weekday_to_str = new Array("日", "一", "二", "三", "四", "五", "六");

            show_text += "转生日{0}年{1}月{2}日 星期{3}\n".format(
                last_day_date.getFullYear(), 
                last_day_date.getMonth() + 1, 
                last_day_date.getDate(),
                weekday_to_str[last_day_date.getDay()]
            );

            var last_day_zone_exp = has_zone_exp(last_day_date) ? zone_exp_pre_time * 6 : 0;

            rest_exp_last_day -= last_day_zone_exp;

            if (rest_exp_last_day <= 0) {
                show_text += "打完经验本即可\n";
                alert(show_text);
                return;
            } else {
                if (has_zone_exp(last_day_date)) {
                    show_text += "首先打完经验本\n";
                }
            }

            var rest_hours = rest_exp_last_day / main_exp_pre_hour;

            if (rest_hours > (24 + speed_up_num * 2)) {
                show_text += "需要等待几乎一整天，并且收取家园经验，建议调整加速次数\n";
                alert(show_text);
                return;
            } else {
                if (rest_hours > (speed_up_num * 2)) {
                    show_text += "加速{1}次后，另外等待{0}小时\n".format((rest_hours - (speed_up_num * 2)).toFixed(3), speed_up_num);
                } else {
                    var last_speed_up = Math.ceil(rest_hours / 2);
                    show_text += "等待{0}小时或加速{1}次\n".format(rest_hours.toFixed(3), last_speed_up);
                }
                show_text += "此处等待时间没有考虑在线情况\n";
                alert(show_text);
                return;
            }
        }
    </script>
</body>
